---
title: "homework 5"
uniqname: "mchenran"
format: 
  html:   
    code-fold: true
    code-summary: "Show the code"
    embed-resources: true
---

The link to my github repository: [homework 5](https://github.com/snuuym/stats506/tree/main/homework%204)

## Problem 1  
### a. 

```{r error=TRUE}
setClass(
  "waldCI",
  slots = list(
    lb    = "numeric",
    ub    = "numeric",
    mean  = "numeric",
    sterr = "numeric",
    level = "numeric"
  ),
  validity = function(object) {
    if (!is.finite(object@level) || object@level <= 0 || object@level >= 1)
      return("level must be between 0 and 1.")

    if (!is.finite(object@lb) || !is.finite(object@ub))
      return("the bound is infinite.")

    if (!is.na(object@lb) && !is.na(object@ub)) {
      if (object@lb >= object@ub)
        return("lb must be < ub.")
    }  
    TRUE
  }
)

############## CONSTRUCTOR ##############

waldCI <- function(level, mean = NULL, sterr = NULL,
                               lb = NULL, ub = NULL) {
  
   z <- qnorm(1 - (1 - level)/2)
   if (!is.null(mean) && !is.null(sterr)){
     lb <- mean - z * sterr
     ub <- mean + z * sterr
   } else if (!is.null(lb) && !is.null(ub)) {
    mean <- (lb + ub) / 2
    sterr <- (ub - lb) / (2 * z)
  } else {
    stop("You must provide either (mean, sterr) or (lb, ub).")
  }
  obj <- new("waldCI",
             lb = lb, ub = ub,
             mean = mean, sterr = sterr,
             level = level)
  
  validObject(obj)
  obj
}

############## SHOW METHOD ##############

setMethod("show", "waldCI",
          function(object) {
            cat("Wald Confidence Interval\n")
            cat(sprintf("Level: %.3f\n", object@level))
            cat(sprintf("Mean:  %.4f\n", object@mean))
            cat(sprintf("SE:    %.4f\n", object@sterr))
            cat(sprintf("CI:   [%.4f, %.4f]\n", object@lb, object@ub))
          })

############## ACCESSORS ##############

setGeneric("lb", function(x) standardGeneric("lb"))
setGeneric("ub", function(x) standardGeneric("ub"))
setGeneric("mean", function(x) standardGeneric("mean"))
setGeneric("sterr", function(x) standardGeneric("sterr"))
setGeneric("level", function(x) standardGeneric("level"))

setMethod("lb", "waldCI", function(x) x@lb)
setMethod("ub", "waldCI", function(x) x@ub)
setMethod("mean", "waldCI", function(x) x@mean)
setMethod("sterr", "waldCI", function(x) x@sterr)
setMethod("level", "waldCI", function(x) x@level)

############## SETTERS (WITH VALIDATION) ##############

setGeneric("lb<-", function(x, value) standardGeneric("lb<-"))
setGeneric("ub<-", function(x, value) standardGeneric("ub<-"))
setGeneric("mean<-", function(x, value) standardGeneric("mean<-"))
setGeneric("sterr<-", function(x, value) standardGeneric("sterr<-"))
setGeneric("level<-", function(x, value) standardGeneric("level<-"))

setMethod("lb<-", "waldCI",
                 function(x, value) {
                   x@lb <- value; validObject(x); x
                 })

setMethod("ub<-", "waldCI",
                 function(x, value) {
                   x@ub <- value; validObject(x); x
                 })

setMethod("mean<-", "waldCI",
                 function(x, value) {
                   x@mean <- value; validObject(x); x
                 })

setMethod("sterr<-", "waldCI",
                 function(x, value) {
                   x@sterr <- value; validObject(x); x
                 })

setMethod("level<-", "waldCI",
                 function(x, value) {
                   x@level <- value; validObject(x); x
                 })

############## CONTAINS FUNCTION ##############

setGeneric("contains", function(object, value) standardGeneric("contains"))
setMethod("contains", c("waldCI","numeric"),
                 function(object, value) {
                   value >= object@lb & value <= object@ub
                 })

############## OVERLAP FUNCTION ##############

setGeneric("overlap", function(object1, object2) standardGeneric("overlap"))
setMethod("overlap", c("waldCI","waldCI"),
                 function(object1, object2) {
                   !(object1@ub < object2@lb || object1@lb > object2@ub)
                 })

############## AS.NUMERIC ##############

setMethod("as.numeric", "waldCI",
          function(x) c(x@lb, x@ub))

############## TRANSFORM CI ##############

setGeneric("transformCI", function(ci, f) standardGeneric("transformCI"))

setMethod("transformCI", c("waldCI","function"),
          function(ci, f) {
            warning("Only monotonic transformations preserve CI meaning.")
            lb2 <- f(ci@lb)
            ub2 <- f(ci@ub)
            waldCI(level = ci@level,
                   lb = min(lb2, ub2),
                   ub = max(lb2, ub2))
          })
```
### b.   
```{r error=TRUE}
ci1 <- waldCI(level = 0.95, lb = 17.2, ub = 24.7)
ci2 <- waldCI(level = 0.99, mean = 13, sterr = 2.5)
ci3 <- waldCI(level = 0.75, lb = 27.43, ub = 39.22)
```
```{r error=TRUE}
ci1
ci2
ci3
as.numeric(ci1)
as.numeric(ci2)
as.numeric(ci3)
lb(ci2)
ub(ci2)
mean(ci1)
sterr(ci3)
level(ci2)
lb(ci2) <- 10.5
mean(ci3) <- 34
level(ci3) <- .8
contains(ci1, 17)
contains(ci3, 44)
overlap(ci1, ci2)
eci1 <- transformCI(ci1, sqrt)
eci1
mean(transformCI(ci2, log))
```
### c.
```{r error=TRUE}
#negative standard error
waldCI(level = 0.95, mean = 1, sterr = -1)
```
```{r error=TRUE}
#lb > ub
waldCI(level = 0.95, lb = 2, ub = 1)
```
```{r error=TRUE}
#Infinite bounds
waldCI(level = 0.95, lb = -Inf, ub = Inf)
```
```{r error=TRUE}
#invalid use of the setters
ci <- waldCI(level = 0.95, lb = 1, ub = 2)
lb(ci) <- 3
```


## Problem 3
```{r}
data <- read.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/refs/heads/master/rolling-averages/us-states.csv")
head(data)
colnames(data)
```

###a. 
How many major and minor spikes in cases were there?
```{r}
#chatgpt taught me how to use ymd() to change date into date type so that it can be further manipulated.
library(plotly)
library(dplyr)
library(lubridate)
covid <- data %>% 
  group_by(date) %>%
  summarise(usa_cases = mean(cases_avg_per_100k))

covid$date <- ymd(covid$date)

fig <- covid %>%
  plot_ly(
    x = ~date,
    y = ~usa_cases,
    type = 'scatter',
    mode = 'lines+markers',
    line = list(width = 2)
  ) %>%
  layout(
    xaxis = list(
      title = "Date",
      tickformat = "%b %Y",  
      dtick = "M3",            
      tickangle = 45          
    ),
    yaxis = list(title = "Cases per 100k"),
    template = "plotly_white"
  )

fig
```

### b. 
For the states with the highest and lowest overall rates per population, what differences do you see in their trajectories over time?
```{r}
states <- data %>% 
  group_by(state) %>%
  summarise(overall_rate = mean(cases_avg,na.rm = TRUE))
high_state <- states %>% slice_max(overall_rate, n = 1) %>% pull(state)
low_state  <- states %>% slice_min(overall_rate, n = 1) %>% pull(state)

prob_b <- data %>% 
  filter(state %in% c(high_state,low_state))

prob_b$date <- ymd(prob_b$date)
fig <- prob_b %>%
  plot_ly(
    x = ~date,
    y = ~cases_avg,
    color = ~state,
    type = "scatter",
    mode = "lines",
    line = list(width = 2)
  ) %>%
  layout(
    xaxis = list(
      title = "Date",
      tickformat = "%b %Y",  
      dtick = "M3",          
      tickangle = 45
    ),
    yaxis = list(title = "Cases per day"),
    template = "plotly_white"
  )

fig
```

### c. 
Identify, to the best of your ability without a formal test, the first five states to experience Covid in a substantial way.
```{r}
first_wave <- data %>%
  filter(cases_avg_per_100k > 1) %>%
  group_by(state) %>%
  summarize(first_date = min(date)) %>%
  arrange(first_date) %>%
  slice_head(n = 5)

first_states <- first_wave$state

cat("The first five states to ecperience Covid in a substantial way are", first_states, sep = ", ")


plot_data <- data %>%
  filter(state %in% first_states) %>%
  mutate(date = ymd(date))

fig <- plot_data %>%
  plot_ly(
    x = ~date,
    y = ~cases_avg_per_100k,
    color = ~state,
    type = "scatter",
    mode = "lines",
    line = list(width = 1)
  ) %>%
  layout(
    xaxis = list(
      title = "Date",
      tickformat = "%b %Y",   # Month Year
      dtick = "M3",           # every 3 months
      tickangle = 45
    ),
    yaxis = list(title = "Cases per 100k"),
    template = "plotly_white"
  )

fig
```
The first five states to ecperience Covid in a substantial way are:  Washington, New York, Guam, Louisiana, New Jersey.
